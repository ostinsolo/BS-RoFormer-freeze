name: build-mac
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-mac-universal:
    name: Build mss-separate Universal (Intel + ARM)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      # Build ARM version (native)
      - name: Setup Python (ARM)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies (ARM)
        run: |
          pip install --upgrade pip
          pip install torch==2.2.2 torchaudio==2.2.2
          pip install "numpy<2" scipy soundfile librosa tqdm pyyaml omegaconf ml_collections einops rotary-embedding-torch beartype loralib matplotlib cx-Freeze==6.15.16
      
      - name: Build ARM executable
        run: |
          cd frozen
          cxfreeze main.py --target-dir=dist-arm --target-name=mss-separate --packages=torch,numpy,scipy,soundfile,librosa,tqdm,yaml,omegaconf,ml_collections,einops,rotary_embedding_torch,beartype,loralib
      
      - name: Copy resources to ARM dist
        run: |
          cp -r configs frozen/dist-arm/
          cp -r models frozen/dist-arm/
          cp -r utils frozen/dist-arm/
          cp frozen/models.json frozen/dist-arm/ || true
          mkdir -p frozen/dist-arm/weights
          SOUNDFILE_DATA=$(python -c "import soundfile; import os; print(os.path.dirname(soundfile.__file__))")/_soundfile_data
          if [ -d "$SOUNDFILE_DATA" ]; then
            mkdir -p frozen/dist-arm/lib
            cp -r "$SOUNDFILE_DATA" frozen/dist-arm/lib/
          fi
      
      # Build Intel version via Rosetta
      - name: Setup Python (Intel via Rosetta)
        run: |
          # Install x86_64 Python via Rosetta
          arch -x86_64 /bin/bash -c "$(curl -fsSL https://www.python.org/ftp/python/3.10.11/python-3.10.11-macos11.pkg)" || true
          # Use system Python or install via pyenv for x86_64
          arch -x86_64 /usr/bin/python3 --version || echo "Will use alternative method"
      
      - name: Build Intel executable via Rosetta
        run: |
          # Create x86_64 venv
          arch -x86_64 python3 -m venv .venv-intel || arch -x86_64 /usr/local/bin/python3 -m venv .venv-intel || echo "Trying pip directly"
          
          # If venv creation fails, we'll build ARM-only and note it
          if [ -d ".venv-intel" ]; then
            source .venv-intel/bin/activate
            arch -x86_64 pip install --upgrade pip
            arch -x86_64 pip install torch==2.2.2 torchaudio==2.2.2
            arch -x86_64 pip install "numpy<2" scipy soundfile librosa tqdm pyyaml omegaconf ml_collections einops rotary-embedding-torch beartype loralib matplotlib cx-Freeze==6.15.16
            cd frozen
            arch -x86_64 cxfreeze main.py --target-dir=dist-intel --target-name=mss-separate --packages=torch,numpy,scipy,soundfile,librosa,tqdm,yaml,omegaconf,ml_collections,einops,rotary_embedding_torch,beartype,loralib
            cd ..
            cp -r configs frozen/dist-intel/
            cp -r models frozen/dist-intel/
            cp -r utils frozen/dist-intel/
            cp frozen/models.json frozen/dist-intel/ || true
            mkdir -p frozen/dist-intel/weights
          else
            echo "Intel build not available - ARM only"
            mkdir -p frozen/dist-intel
            cp frozen/dist-arm/mss-separate frozen/dist-intel/ || true
          fi
      
      - name: Create Universal binary with lipo
        run: |
          mkdir -p frozen/dist
          
          # Check if we have both architectures
          ARM_ARCH=$(file frozen/dist-arm/mss-separate | grep -o 'arm64' || echo "")
          INTEL_ARCH=$(file frozen/dist-intel/mss-separate | grep -o 'x86_64' || echo "")
          
          if [ -n "$ARM_ARCH" ] && [ -n "$INTEL_ARCH" ]; then
            echo "Creating Universal binary..."
            lipo -create frozen/dist-arm/mss-separate frozen/dist-intel/mss-separate -output frozen/dist/mss-separate
            file frozen/dist/mss-separate
          else
            echo "Using ARM-only binary (Intel build failed)"
            cp frozen/dist-arm/mss-separate frozen/dist/
          fi
          
          # Copy resources
          cp -r frozen/dist-arm/configs frozen/dist/
          cp -r frozen/dist-arm/models frozen/dist/
          cp -r frozen/dist-arm/utils frozen/dist/
          cp -r frozen/dist-arm/lib frozen/dist/ || true
          cp frozen/dist-arm/models.json frozen/dist/ || true
          mkdir -p frozen/dist/weights
          chmod +x frozen/dist/mss-separate
      
      - name: Test executable
        run: |
          ./frozen/dist/mss-separate --list-models
      
      - name: Package
        run: |
          cd frozen
          tar -czf ../mss-separate-macos-universal.tar.gz dist
      
      - uses: actions/upload-artifact@v4
        with:
          name: mss-separate-macos-universal
          path: mss-separate-macos-universal.tar.gz
      
      # Also create ARM-only package as backup
      - name: Package ARM-only
        run: |
          cd frozen
          mv dist-arm dist
          tar -czf ../mss-separate-macos-arm.tar.gz dist
      
      - uses: actions/upload-artifact@v4
        with:
          name: mss-separate-macos-arm
          path: mss-separate-macos-arm.tar.gz

  release:
    name: Create macOS Release
    needs: [build-mac-universal]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: mss-separate-macos-universal
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: mss-separate-macos-arm
          path: ./artifacts
      - run: ls -la ./artifacts/
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## BS-RoFormer ${{ github.ref_name }} - macOS
            
            State-of-the-art music source separation using BS-RoFormer architecture.
            
            ### v1.8.0 New Features
            - `--two-stems X` - Demucs-style output (stem + no_stem)
            - `--stems X,Y` - Select specific stems to output
            - `--extract-instrumental` - Generate instrumental from vocal models
            - `--flac` / `--pcm-type` - Output format options
            - 28 models with accurate stem outputs
            
            ### macOS Downloads
            | Platform | File |
            |----------|------|
            | macOS Universal (Intel+ARM) | mss-separate-macos-universal.tar.gz |
            | macOS ARM only | mss-separate-macos-arm.tar.gz |
            
            *Windows builds available separately*
          files: |
            ./artifacts/mss-separate-macos-universal.tar.gz
            ./artifacts/mss-separate-macos-arm.tar.gz
          draft: false
          prerelease: false

