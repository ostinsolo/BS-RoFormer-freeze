name: Build Windows CUDA

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags

jobs:
  build-windows-cuda:
    name: Build mss-separate for Windows (CUDA)
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install PyTorch with CUDA 12.6
        run: |
          pip install --upgrade pip
          pip install torch==2.2.2 torchaudio==2.2.2 --index-url https://download.pytorch.org/whl/cu121
      
      - name: Install other dependencies
        run: |
          pip install "numpy<2" scipy soundfile librosa tqdm pyyaml omegaconf ml_collections einops rotary-embedding-torch beartype loralib matplotlib cx-Freeze==6.15.16
      
      - name: Build executable with cx_Freeze
        run: |
          cd frozen
          cxfreeze main.py --target-dir=dist --target-name=mss-separate --packages=torch,numpy,scipy,soundfile,librosa,tqdm,yaml,omegaconf,ml_collections,einops,rotary_embedding_torch,beartype,loralib
      
      - name: Copy project files
        run: |
          Copy-Item -Path "configs" -Destination "frozen/dist/configs" -Recurse
          Copy-Item -Path "models" -Destination "frozen/dist/models" -Recurse
          Copy-Item -Path "utils" -Destination "frozen/dist/utils" -Recurse
          New-Item -ItemType Directory -Force -Path "frozen/dist/weights"
        shell: pwsh
      
      - name: Copy soundfile data
        run: |
          $soundfileDir = python -c "import soundfile; import os; print(os.path.dirname(soundfile.__file__))"
          $soundfileData = Join-Path $soundfileDir "_soundfile_data"
          if (Test-Path $soundfileData) {
            New-Item -ItemType Directory -Force -Path "frozen/dist/lib"
            Copy-Item -Path $soundfileData -Destination "frozen/dist/lib/_soundfile_data" -Recurse
          }
        shell: pwsh
      
      - name: Download 7-Zip
        run: |
          Invoke-WebRequest -Uri https://www.7-zip.org/a/7zr.exe -OutFile 7zr.exe
          Invoke-WebRequest -Uri https://www.7-zip.org/a/7z2409-x64.exe -OutFile 7zInstaller-x64.exe
          .\7zr.exe x "7zInstaller-x64.exe"
        shell: pwsh
      
      - name: Create archive
        run: |
          .\7z.exe a -m0=lzma2 -mmt=on -mx=9 "mss-separate-win-cuda.7z" "frozen/dist"
        shell: pwsh
      
      - name: Get version from tag or commit
        id: version
        run: |
          if ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}"
          } else {
            $version = "dev-${{ github.sha }}".Substring(0, 15)
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mss-separate-win-cuda-${{ steps.version.outputs.VERSION }}
          path: mss-separate-win-cuda.7z
      
      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: mss-separate-win-cuda.7z
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

